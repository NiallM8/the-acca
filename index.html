<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Acca - League Table</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            --font-body: 'Inter', Arial, sans-serif;
            --font-title: 'Montserrat', sans-serif;

            /* Accent Color Variables (will be updated by JS) */
            --primary-accent-color: #0B57D0; /* Default Blue */
            --primary-accent-light: #A8C7FA;
            --primary-header-bg: #E8F0FE;
            --primary-accent-text-on-light-bg: #0B57D0; /* Text color on light header */

            /* Fixed Row Highlight Colors (Light) */
            --row-highlight-first-light: #e6f4ea; /* Greenish */
            --row-highlight-money-light: #e9f5fe; /* Bluish */
            --row-highlight-relegation-light: #fce8e6; /* Reddish */

            /* Base Light Theme */
            --body-bg: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #1f1f1f;
            --text-color-soft: #5f6368;
            --text-color-softer: #474747;
            --border-color: #e0e0e0;
            --shadow-color-soft: rgba(0,0,0,0.08);
            --shadow-color-medium: rgba(0,0,0,0.05);
            --toggle-slider-bg: #d0d0d0;
            --toggle-knob-bg: #ffffff;
            --toggle-knob-shadow: rgba(0,0,0,0.2);
            --nav-inactive-color: #5f6368;
            --nav-hover-bg: #f0f4ff;
            --row-hover: #f0f4ff;
            --row-highlight-first: var(--row-highlight-first-light);
            --row-highlight-money: var(--row-highlight-money-light);
            --row-highlight-relegation: var(--row-highlight-relegation-light);
            --stats-hero-bg: #f1f3f4; /* Light background for hero panel */
            --chart-bg-color: #ffffff; /* Chart background */
            --chart-border-color: var(--border-color);
            --chart-grid-color: rgba(0, 0, 0, 0.05);
            --chart-label-color: var(--text-color-soft);
            --chart-tooltip-bg: rgba(0, 0, 0, 0.7);
            --chart-tooltip-text: #ffffff;
        }

        body.theme-dark {
            /* Accent Color Variables are now set ONLY by JS */
            
            /* Fixed Row Highlight Colors (Dark) */
            --row-highlight-first-dark: #2a3b2c; 
            --row-highlight-money-dark: #2c3a4f; 
            --row-highlight-relegation-dark: #4d3230; 

            /* Base Dark Theme */
            --body-bg: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-color-soft: #b0b0b0;
            --text-color-softer: #9e9e9e;
            --border-color: #3a3a3a;
            --shadow-color-soft: rgba(0,0,0,0.25);
            --shadow-color-medium: rgba(0,0,0,0.15);
            --toggle-slider-bg: #555555;
            --toggle-knob-bg: #cfcfcf;
            --toggle-knob-shadow: rgba(0,0,0,0.4);
            --nav-inactive-color: #b0b0b0;
            --nav-hover-bg: #2c3a4f;
            --row-hover: #3a4a6b;
            --row-highlight-first: var(--row-highlight-first-dark);
            --row-highlight-money: var(--row-highlight-money-dark);
            --row-highlight-relegation: var(--row-highlight-relegation-dark);
            --stats-hero-bg: #282828; /* Dark background for hero panel */
            --chart-bg-color: #282828; /* Chart background */
            --chart-border-color: var(--border-color);
            --chart-grid-color: rgba(255, 255, 255, 0.1);
             --chart-label-color: var(--text-color-soft);
            --chart-tooltip-bg: rgba(255, 255, 255, 0.7);
            --chart-tooltip-text: #000000;
        }

        body {
            font-family: var(--font-body);
            margin: 0;
            padding: 20px 20px 80px 20px; 
            background-color: var(--body-bg); 
            color: var(--text-color); 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            background-color: var(--container-bg); 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px var(--shadow-color-soft); 
            margin-bottom: 20px; 
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        h1 {
            font-family: var(--font-title);
            text-align: center;
            color: var(--primary-accent-color); 
            margin-top: 0; 
            margin-bottom: 35px; 
            font-weight: 700; 
        }

        /* View specific styles */
        #tableView, #settingsView, #statsView { 
            width: 100%;
        }
        #settingsView, #statsView { 
             padding-top: 10px; 
        }
        #settingsView h2, #statsView h2 { 
            color: var(--primary-accent-color);
            text-align: center;
            margin-top: 0; 
            margin-bottom: 30px; 
            font-size: 1.6em;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
         #settingsView p.settings-intro, #statsView p.stats-intro { 
            color: var(--text-color-soft);
            margin-bottom: 25px;
            text-align: center;
        }
        .settings-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--body-bg); 
            text-align: left; 
        }
        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 1.2em;
        }
        .settings-options label {
            display: block;
            margin-bottom: 12px;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        .settings-options label:hover {
            background-color: var(--nav-hover-bg); 
        }
        .settings-options input[type="radio"] {
            margin-right: 10px;
            accent-color: var(--primary-accent-color); 
        }
        .color-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 12px; 
            margin-top: 10px;
        }
        .color-swatch {
            width: 32px; 
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent; 
            transition: transform 0.2s ease, border-color 0.2s ease;
            box-sizing: border-box;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.active-swatch {
            border-color: var(--primary-accent-color);
        }

        /* Stats View Specific Styles */
        #statsView .player-select-container {
            margin-bottom: 20px; /* Reduced margin */
            text-align: right; 
        }
        #statsView label { 
             margin-right: 8px; 
             font-weight: 500;
             font-size: 0.9em; 
             color: var(--text-color-soft);
        }
        #playerStatsSelect, #statDataSelect, #chartTypeSelect { /* Apply to all selects */
            padding: 6px 10px; 
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--container-bg);
            color: var(--text-color);
            font-family: var(--font-body);
            font-size: 0.9em; 
            min-width: 140px; /* Adjusted min-width */
            cursor: pointer;
            margin-left: 5px; /* Space between label and select */
        }
        #playerStatsDisplay {
            margin-top: 20px;
            padding: 0; 
            border: none; 
            min-height: 100px;
            text-align: center; 
            color: var(--text-color-soft);
        }
        .stats-hero-panel {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--stats-hero-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .hero-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hero-stat-label {
            font-size: 0.9em;
            color: var(--text-color-soft);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .hero-stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--primary-accent-color);
        }
        .stats-chart-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow controls to wrap on smaller screens */
        }
        #statsChartContainer {
            width: 100%;
            max-width: 600px; /* Max width for the chart */
            margin: 20px auto; /* Center the chart */
            padding: 15px;
            background-color: var(--chart-bg-color);
            border: 1px solid var(--chart-border-color);
            border-radius: 8px;
        }
         #statsChart {
             width: 100% !important; /* Ensure canvas fills container */
             height: auto !important;
             aspect-ratio: 16 / 9; /* Maintain aspect ratio */
         }


        /* Table Controls (toggle switch) */
        .table-controls { 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 30px; 
        }

        .toggle-label-text {
            margin: 0 8px; 
            font-size: 0.9em; 
            color: var(--text-color-softer); 
            cursor: default;
            transition: font-weight 0.3s ease, color 0.3s ease;
        }

        .toggle-label-text.active-label {
            font-weight: 500; 
            color: var(--primary-accent-color); 
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px; 
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-slider-bg); 
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 20px; 
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: var(--toggle-knob-bg);
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 3px var(--toggle-knob-shadow); 
        }

        input:checked + .slider {
            background-color: var(--primary-accent-light); 
        }
        input:checked + .slider:before {
            background-color: var(--primary-accent-color); 
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }
        input:focus + .slider {
            box-shadow: 0 0 0 2px var(--primary-accent-light); 
        }
       
        table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0; 
            margin: 0 auto;
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 2px 6px var(--shadow-color-medium); 
        }
        th, td {
            padding: 14px 18px; 
            text-align: left; 
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color); 
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        tr:last-child td {
            border-bottom: none; 
        }

        th {
            background-color: var(--primary-header-bg); 
            color: var(--primary-accent-text-on-light-bg); /* Use specific variable */
            font-weight: 500; 
            font-size: 0.98em;
        }
        
        tr {
             background-color: var(--container-bg); 
        }
        tr:nth-child(even) {
            background-color: var(--body-bg); 
        }
        
        .row-first-place {
            background-color: var(--row-highlight-first) !important; 
        }
        .row-money-position {
            background-color: var(--row-highlight-money) !important; 
        }
        .row-relegation-zone {
            background-color: var(--row-highlight-relegation) !important; 
        }

        tr:hover {
            background-color: var(--row-hover) !important; 
        }

        .text-center-col {
            text-align: center;
        }

        td.col-playerWithMovement { 
            display: flex !important; 
            align-items: center;
        }

        .movement-indicator-wrapper {
            flex-shrink: 0; 
            display: inline-flex; 
            align-items: center;
            justify-content: center; 
            width: 45px; 
            margin-right: 8px; 
            font-weight: 500;
        }
        
        .player-name-display {
            flex-grow: 1; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }

        .movement-indicator {
            font-size: 1.1em; 
            line-height: 1; 
        }
        .pos-up { color: #188038; } 
        .pos-down { color: #D93025; } 
        .pos-same { color: #FFC107; } 

        .places-moved {
            font-size: 0.75em; 
            margin-left: 3px;
            font-weight: 400; 
            line-height: 1;
        }

        #messageArea {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: var(--text-color-soft); 
        }

        /* Bottom Navigation Bar Styles */
        #bottomNav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px; 
            background-color: var(--container-bg); 
            display: flex;
            justify-content: space-around; 
            align-items: center;
            box-shadow: 0 -2px 8px var(--shadow-color-soft); 
            z-index: 1000; 
            border-top-left-radius: 16px; 
            border-top-right-radius: 16px; 
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1; 
            height: 100%;
            color: var(--nav-inactive-color); 
            text-decoration: none;
            font-size: 0.75em; 
            cursor: pointer;
            transition: color 0.3s ease, background-color 0.3s ease;
            padding: 4px 0; 
        }
        .nav-item svg {
            width: 24px; 
            height: 24px; 
            margin-bottom: 2px; 
        }
        .nav-item.active {
            color: var(--primary-accent-color); 
        }
        .nav-item:hover:not(.active) {
            background-color: var(--nav-hover-bg); 
        }


        @media screen and (max-width: 768px) {
            body { padding: 15px 15px 70px 15px; } 
            .container { padding: 20px; border-radius: 12px;}
            h1 { font-size: 1.7em; margin-bottom: 25px; }
            .table-controls { margin-bottom: 20px; }
            .toggle-label-text { font-size: 0.85em; margin: 0 6px;}
            .switch { width: 34px; height: 18px; }
            .slider:before { height: 12px; width: 12px; }
            input:checked + .slider:before { transform: translateX(16px); }

            table { border-radius: 10px; }
            th, td { padding: 10px 12px; font-size: 0.9em; }
            
            .movement-indicator-wrapper {
                width: 40px; 
                margin-right: 6px;
            }
            .movement-indicator { font-size: 1em; }
            .places-moved { font-size: 0.7em; margin-left: 2px;}
            .player-name-display {
                 white-space: normal; 
            }
            #bottomNav { height: 56px; } 
            .nav-item svg { width: 22px; height: 22px; }
            .nav-item { font-size: 0.7em; }

             .stats-hero-panel { flex-direction: column; gap: 15px; padding: 15px;}
             .hero-stat-value { font-size: 1.6em; }
             #statsView .player-select-container { text-align: center; } 
             .stats-chart-controls { gap: 10px; }
             #playerStatsSelect, #statDataSelect, #chartTypeSelect { min-width: 120px; }
        }
        @media screen and (max-width: 480px) {
            body { padding: 10px 10px 60px 10px; }
            .container { padding: 15px; border-radius: 8px; }
            h1 { font-size: 1.5em; margin-bottom: 20px; }
             th, td { padding: 8px 10px; font-size: 0.8em;}
             .movement-indicator-wrapper {
                width: 35px; 
                margin-right: 4px;
            }
             .movement-indicator { font-size: 0.95em;}
             .places-moved { font-size: 0.65em;}
             #playerStatsSelect, #statDataSelect, #chartTypeSelect { min-width: 100px; font-size: 0.85em;}
             #statsView label { font-size: 0.85em;}
             .stats-chart-controls { flex-direction: column; align-items: center; }
             #statsChartContainer { padding: 10px; }
        }
    </style>
    </head>
<body>
    <div class="container">
        <h1>The Acca League Table</h1>

        <div id="tableView">
            <div class="table-controls">
                <span class="toggle-label-text active-label" id="condensedViewLabel">Condensed</span>
                <label class="switch">
                    <input type="checkbox" id="viewToggleSwitch">
                    <span class="slider round"></span>
                </label>
                <span class="toggle-label-text" id="fullTableViewLabel">Full Table</span>
            </div>

            <div id="messageArea">
                <p id="loadingMessage">Loading league table...</p>
            </div>
            <div style="overflow-x: auto;">
                <table id="leagueTable" style="display:none;">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="statsView" style="display:none;">
             <h2>Player Stats</h2>
             <div class="player-select-container">
                 <label for="playerStatsSelect">Select Player:</label>
                 <select id="playerStatsSelect">
                     <option value="">-- Select Player --</option>
                     </select>
             </div>
             
             <div id="playerStatsDisplay">
                 Select a player from the dropdown above.
             </div>

             <div class="stats-chart-controls" style="display: none;"> <div>
                     <label for="statDataSelect">Stat:</label>
                     <select id="statDataSelect">
                         <option value="wl">Wins / Losses</option>
                         <option value="gfga">Goals For / Against</option>
                         </select>
                 </div>
                 <div>
                     <label for="chartTypeSelect">Chart Type:</label>
                     <select id="chartTypeSelect">
                         <option value="bar">Bar</option>
                         <option value="doughnut">Doughnut</option>
                         <option value="pie">Pie</option>
                         </select>
                 </div>
             </div>

             <div id="statsChartContainer" style="display: none;"> <canvas id="statsChart"></canvas>
             </div>
        </div>

        <div id="settingsView" style="display:none;">
            <h2>Appearance Settings</h2>
            <p class="settings-intro">Customise the look and feel of the app.</p>
            
            <div class="settings-section">
                <h3>Theme Mode</h3>
                <div class="settings-options" id="themeModeOptions">
                    <label><input type="radio" name="themeMode" value="system" checked> System</label>
                    <label><input type="radio" name="themeMode" value="light"> Light</label>
                    <label><input type="radio" name="themeMode" value="dark"> Dark</label>
                </div>
            </div>

            <div class="settings-section">
                <h3>Accent Color</h3>
                <div class="color-swatches" id="accentColorSwatches">
                    </div>
            </div>
        </div>
    </div>

    <nav id="bottomNav">
        <a href="#" class="nav-item active" data-view="tableView">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 9.5H21M3 14.5H21M8 4.5V19.5M6.2 19.5H17.8C18.9201 19.5 19.4802 19.5 19.908 19.282C20.2843 19.0903 20.5903 18.7843 20.782 18.408C21 17.9802 21 17.4201 21 16.3V7.7C21 6.5799 21 6.01984 20.782 5.59202C20.5903 5.21569 20.2843 4.90973 19.908 4.71799C19.4802 4.5 18.9201 4.5 17.8 4.5H6.2C5.0799 4.5 4.51984 4.5 4.09202 4.71799C3.71569 4.90973 3.40973 5.21569 3.21799 5.59202C3 6.01984 3 6.57989 3 7.7V16.3C3 17.4201 3 17.9802 3.21799 18.408C3.40973 18.7843 3.71569 19.0903 4.09202 19.282C4.51984 19.5 5.07989 19.5 6.2 19.5Z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>Table</span>
        </a>
        <a href="#" class="nav-item" data-view="statsView"> 
             <svg viewBox="-2.8 0 95 95" xmlns="http://www.w3.org/2000/svg" fill="none">
                <g transform="translate(-641.5 -462.6)">
                    <path d="M721.7,555.6h-71a7.17,7.17,0,0,1-7.2-7.2h0a7.17,7.17,0,0,1,7.2-7.2h71a7.17,7.17,0,0,1,7.2,7.2h0A7.17,7.17,0,0,1,721.7,555.6Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="4"/>
                    <path d="M656.2,464.6h-5a7.768,7.768,0,0,0-7.7,7.7v47.6a7.768,7.768,0,0,0,7.7,7.7h5a7.768,7.768,0,0,0,7.7-7.7V472.3A7.7,7.7,0,0,0,656.2,464.6Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="4"/>
                    <path d="M691.3,496.2h-9.6a5.378,5.378,0,0,0-5.4,5.4v20.5a5.378,5.378,0,0,0,5.4,5.4h9.6a5.378,5.378,0,0,0,5.4-5.4V501.6A5.378,5.378,0,0,0,691.3,496.2Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="4"/>
                    <path d="M722.4,482.4H715a6.487,6.487,0,0,0-6.5,6.5V521a6.487,6.487,0,0,0,6.5,6.5h7.4a6.487,6.487,0,0,0,6.5-6.5V488.9A6.487,6.487,0,0,0,722.4,482.4Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="4"/>
                </g>
             </svg>
             <span>Stats</span>
        </a>
        <a href="#" class="nav-item" data-view="settingsView">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/>
                <path d="M3.66122 10.6392C4.13377 10.9361 4.43782 11.4419 4.43782 11.9999C4.43781 12.558 4.13376 13.0638 3.66122 13.3607C3.33966 13.5627 3.13248 13.7242 2.98508 13.9163C2.66217 14.3372 2.51966 14.869 2.5889 15.3949C2.64082 15.7893 2.87379 16.1928 3.33973 16.9999C3.80568 17.8069 4.03865 18.2104 4.35426 18.4526C4.77508 18.7755 5.30694 18.918 5.83284 18.8488C6.07287 18.8172 6.31628 18.7185 6.65196 18.5411C7.14544 18.2803 7.73558 18.2699 8.21895 18.549C8.70227 18.8281 8.98827 19.3443 9.00912 19.902C9.02332 20.2815 9.05958 20.5417 9.15224 20.7654C9.35523 21.2554 9.74458 21.6448 10.2346 21.8478C10.6022 22 11.0681 22 12 22C12.9319 22 13.3978 22 13.7654 21.8478C14.2554 21.6448 14.6448 21.2554 14.8478 20.7654C14.9404 20.5417 14.9767 20.2815 14.9909 19.9021C15.0117 19.3443 15.2977 18.8281 15.7811 18.549C16.2644 18.27 16.8545 18.2804 17.3479 18.5412C17.6837 18.7186 17.9271 18.8173 18.1671 18.8489C18.693 18.9182 19.2249 18.7756 19.6457 18.4527C19.9613 18.2106 20.1943 17.807 20.6603 17C20.8677 16.6407 21.029 16.3614 21.1486 16.1272M20.3387 13.3608C19.8662 13.0639 19.5622 12.5581 19.5621 12.0001C19.5621 11.442 19.8662 10.9361 20.3387 10.6392C20.6603 10.4372 20.8674 10.2757 21.0148 10.0836C21.3377 9.66278 21.4802 9.13092 21.411 8.60502C21.3591 8.2106 21.1261 7.80708 20.6601 7.00005C20.1942 6.19301 19.9612 5.7895 19.6456 5.54732C19.2248 5.22441 18.6929 5.0819 18.167 5.15113C17.927 5.18274 17.6836 5.2814 17.3479 5.45883C16.8544 5.71964 16.2643 5.73004 15.781 5.45096C15.2977 5.1719 15.0117 4.6557 14.9909 4.09803C14.9767 3.71852 14.9404 3.45835 14.8478 3.23463C14.6448 2.74458 14.2554 2.35523 13.7654 2.15224C13.3978 2 12.9319 2 12 2C11.0681 2 10.6022 2 10.2346 2.15224C9.74458 2.35523 9.35523 2.74458 9.15224 3.23463C9.05958 3.45833 9.02332 3.71848 9.00912 4.09794C8.98826 4.65566 8.70225 5.17191 8.21891 5.45096C7.73557 5.73002 7.14548 5.71959 6.65205 5.4588C6.31633 5.28136 6.0729 5.18269 5.83285 5.15108C5.30695 5.08185 4.77509 5.22436 4.35427 5.54727C4.03866 5.78945 3.80569 6.19297 3.33974 7C3.13231 7.35929 2.97105 7.63859 2.85138 7.87273" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <span>Settings</span>
        </a>
    </nav>

    <script>
        // URL for the Google Sheet published as CSV
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTs_5bRoiwvSe1ALIAIoo8dCP_eIhIm9dk5eQplyFbwojrbhI0JRHYTysVjfSiW6RdIf-EqGFggZ7RY/pub?output=csv';

        // --- Configuration: Column Mapping and Definitions ---
        const columnMapping = {
            'name': 'player',
            'matchesPlayed': 'mp',
            'wins': 'w',
            'losses': 'l',
            'goalsFor': 'gf',
            'goalsAgainst': 'ga',
            'goalDifference': 'gd',
            'winPercentage': 'winPercentage',
            'averageOdds': 'avgOdds',
            'expectedWinPercentage': 'expectedWinPercentage',
            'points': 'pts',
            'previousPosition': 'previousPositionValue'
        };
        const tableColumnDefinitions = [
            { key: 'pos', header: 'Pos', isExpandedOnly: false, centerAlign: false },
            { key: 'playerWithMovement', header: 'Player', isExpandedOnly: false, centerAlign: false }, 
            { key: 'mp', header: 'MP', isExpandedOnly: false, centerAlign: true },
            { key: 'w', header: 'W', isExpandedOnly: false, centerAlign: true },
            { key: 'l', header: 'L', isExpandedOnly: false, centerAlign: true },
            { key: 'gf', header: 'GF', isExpandedOnly: true, centerAlign: true },
            { key: 'ga', header: 'GA', isExpandedOnly: true, centerAlign: true },
            { key: 'gd', header: 'GD', isExpandedOnly: false, centerAlign: true },
            { key: 'winPercentage', header: 'Win %', isExpandedOnly: true, centerAlign: true },
            { key: 'avgOdds', header: 'Avg Odds', isExpandedOnly: true, centerAlign: true },
            { key: 'expectedWinPercentage', header: 'xWin %', isExpandedOnly: true, centerAlign: true },
            { key: 'pts', header: 'Pts', isExpandedOnly: false, centerAlign: true }
        ];
        
        // --- Accent Color Definitions ---
        const accentColors = [
            { name: 'Default Blue', value: '#0B57D0', lightValue: '#A8C7FA', headerBg: '#E8F0FE', textOnLight: '#0B57D0', darkValue: '#7cacf8', darkLightValue: '#4a69bb', darkHeaderBg: '#2c3a4f', darkTextOnLight: '#7cacf8'},
            { name: 'Custom Green', value: '#65fcac', lightValue: '#b2fcdb', headerBg: '#d9fff0', textOnLight: '#007d3e', darkValue: '#83fcc2', darkLightValue: '#3ba072', darkHeaderBg: '#1e4d32', darkTextOnLight: '#83fcc2'},
            { name: 'Material Red', value: '#B3261E', lightValue: '#f8b5b0', headerBg: '#fce8e6', textOnLight: '#B3261E', darkValue: '#f28b82', darkLightValue: '#a53c3c', darkHeaderBg: '#5c1f1f', darkTextOnLight: '#f28b82'},
            { name: 'Material Pink', value: '#E91E63', lightValue: '#fcc2d8', headerBg: '#fce4ec', textOnLight: '#E91E63', darkValue: '#f48fb1', darkLightValue: '#b05977', darkHeaderBg: '#632539', darkTextOnLight: '#f48fb1'},
            { name: 'Material Purple', value: '#6750A4', lightValue: '#d1c4e9', headerBg: '#ede7f6', textOnLight: '#6750A4', darkValue: '#b39ddb', darkLightValue: '#7e57c2', darkHeaderBg: '#3c2f5d', darkTextOnLight: '#b39ddb'},
            { name: 'Material Orange', value: '#FB8C00', lightValue: '#ffe0b2', headerBg: '#fff3e0', textOnLight: '#FB8C00', darkValue: '#ffcc80', darkLightValue: '#ef6c00', darkHeaderBg: '#783d00', darkTextOnLight: '#ffcc80'},
            { name: 'Material Yellow', value: '#FDD835', lightValue: '#fff9c4', headerBg: '#fffde7', textOnLight: '#c6a700', darkValue: '#fff176', darkLightValue: '#fbc02d', darkHeaderBg: '#7c6000', darkTextOnLight: '#fff176'}
        ];


        // --- Global State ---
        let currentTableDisplayView = 'condensed'; 
        let currentAppView = 'tableView'; 
        let allPlayersData = []; 
        let playerStatsChart = null; // Variable to hold the chart instance

        // --- DOM Elements ---
        const docElement = document.documentElement; 
        const bodyElement = document.body; 
        const loadingMessageEl = document.getElementById('loadingMessage');
        const messageAreaEl = document.getElementById('messageArea');
        const leagueTableEl = document.getElementById('leagueTable');
        const viewToggleSwitchEl = document.getElementById('viewToggleSwitch');
        const condensedViewLabelEl = document.getElementById('condensedViewLabel');
        const fullTableViewLabelEl = document.getElementById('fullTableViewLabel');
        
        const tableViewEl = document.getElementById('tableView');
        const settingsViewEl = document.getElementById('settingsView');
        const statsViewEl = document.getElementById('statsView'); 
        const navItems = document.querySelectorAll('.nav-item');
        const themeModeOptionsEl = document.getElementById('themeModeOptions'); 
        const accentColorSwatchesEl = document.getElementById('accentColorSwatches'); 
        const playerStatsSelectEl = document.getElementById('playerStatsSelect'); 
        const playerStatsDisplayEl = document.getElementById('playerStatsDisplay'); 
        const statsChartControlsEl = document.querySelector('.stats-chart-controls'); // Chart controls container
        const statDataSelectEl = document.getElementById('statDataSelect'); // Stat selection dropdown
        const chartTypeSelectEl = document.getElementById('chartTypeSelect'); // Chart type dropdown
        const statsChartContainerEl = document.getElementById('statsChartContainer'); // Chart container
        const statsChartCanvasEl = document.getElementById('statsChart'); // Canvas element


        // --- Core Functions ---
        
        /**
         * Fetches CSV data, processes it, populates table and stats dropdown.
         */
        async function fetchDataAndInitialize() {
             if (allPlayersData.length > 0 || (messageAreaEl && messageAreaEl.textContent.includes("Error"))) {
                if(allPlayersData.length > 0 && playerStatsSelectEl && playerStatsSelectEl.options.length <= 1) {
                    populateStatsDropdown();
                }
                return; 
            }
            if (messageAreaEl) {
                messageAreaEl.style.display = 'block';
                if (loadingMessageEl) loadingMessageEl.textContent = 'Loading league data...'; 
            }
            if (leagueTableEl) leagueTableEl.style.display = 'none'; 

            try {
                const response = await fetch(csvUrl, { cache: "no-store" });
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();
                allPlayersData = parseAndProcessCsv(csvText);
                
                if (allPlayersData.length > 0) {
                    renderLeagueTable(); 
                    populateStatsDropdown(); 
                    if (messageAreaEl) messageAreaEl.style.display = 'none'; 
                    if (leagueTableEl) leagueTableEl.style.display = ''; 
                } else {
                    if (loadingMessageEl) loadingMessageEl.textContent = 'No player data found or CSV is empty.';
                    if (leagueTableEl) leagueTableEl.style.display = 'none';
                }
            } catch (error) { 
                console.error('Error fetching or processing league data:', error);
                if (loadingMessageEl) loadingMessageEl.textContent = `Error loading table: ${error.message}. Please check the CSV link and format.`;
                if (leagueTableEl) leagueTableEl.style.display = 'none'; 
                 if (messageAreaEl) messageAreaEl.style.display = 'block'; 
            } 
        }

        /**
         * Parses raw CSV text into an array of player objects and processes them.
         * @param {string} csvText - The raw CSV data as a string.
         * @returns {Array<Object>} Processed and sorted player data.
         */
        function parseAndProcessCsv(csvText) {
            const rows = csvText.trim().split('\n');
            if (rows.length < 2) {
                console.warn("CSV data is empty or has no data rows.");
                return [];
            }
            const rawHeaders = rows.shift().trim().split(',');
            const headers = rawHeaders.map(h => h.replace(/^\uFEFF/, "").trim().replace(/^"|"$/g, ''));

            const headerIndices = {};
            for (const csvHeaderKey in columnMapping) {
                const internalKey = columnMapping[csvHeaderKey];
                const index = headers.indexOf(csvHeaderKey);
                if (index === -1) {
                    console.warn(`Required CSV Header "${csvHeaderKey}" (for internal key "${internalKey}") not found. Column will be missing.`);
                }
                headerIndices[internalKey] = index;
            }
            
            if (headerIndices.pts === undefined || headerIndices.pts === -1) {
                throw new Error("'points' column (mapped to 'pts') is missing in the CSV. Table cannot be sorted.");
            }
            if (headerIndices.player === undefined || headerIndices.player === -1) {
                throw new Error("'name' column (mapped to 'player') is missing. Player names cannot be displayed.");
            }

            let players = rows.map(rowStr => {
                const values = rowStr.trim().split(',');
                const player = {};
                for (const internalKey in headerIndices) {
                    const csvIndex = headerIndices[internalKey];
                    if (csvIndex !== -1 && values[csvIndex] !== undefined) {
                        let value = values[csvIndex].trim().replace(/^"|"$/g, '');
                        const numericKeys = ['mp', 'w', 'l', 'gf', 'ga', 'gd', 'pts', 'previousPositionValue'];
                        if (numericKeys.includes(internalKey)) {
                            value = parseFloat(value);
                            if (isNaN(value)) value = 0; 
                        }
                        player[internalKey] = value;
                    } else {
                        const numericKeys = ['mp', 'w', 'l', 'gf', 'ga', 'gd', 'pts', 'previousPositionValue'];
                        player[internalKey] = (numericKeys.includes(internalKey)) ? 0 : null;
                    }
                }
                return player;
            }).filter(p => p.player && p.player.trim() !== "");

            // Sort players based on league rules (Points DESC, GD DESC, GF DESC, Name ASC)
            players.sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                if (b.gd !== a.gd) return b.gd - a.gd;
                if (b.gf !== a.gf) return b.gf - a.gf;
                return a.player.localeCompare(b.player);
            });

            // Assign position and movement indicator AFTER sorting
            return players.map((player, index) => {
                const currentPos = index + 1; 
                player.pos = currentPos; 
                
                let movementHtml = ''; 
                let placesMoved = 0;

                if (player.previousPositionValue !== null && !isNaN(player.previousPositionValue) && player.previousPositionValue > 0) {
                    const prevPos = parseInt(player.previousPositionValue, 10);
                    placesMoved = Math.abs(currentPos - prevPos);

                    if (currentPos < prevPos) {
                        movementHtml = `<span class="movement-indicator pos-up">↑<span class="places-moved">${placesMoved}</span></span>`;
                    } else if (currentPos > prevPos) {
                        movementHtml = `<span class="movement-indicator pos-down">↓<span class="places-moved">${placesMoved}</span></span>`;
                    } else { 
                        movementHtml = `<span class="movement-indicator pos-same">–</span>`;
                    }
                } else { 
                    movementHtml = `<span class="movement-indicator pos-same">–</span>`;
                }
                player.playerWithMovement = `<span class="movement-indicator-wrapper">${movementHtml}</span><span class="player-name-display">${player.player || 'N/A'}</span>`;
                return player;
            });
        }

        /**
         * Renders the league table content.
         */
        function renderLeagueTable() {
             if (!leagueTableEl) return;
             const thead = leagueTableEl.querySelector('thead');
             const tbody = leagueTableEl.querySelector('tbody');
             if (!thead || !tbody) return;

            thead.innerHTML = ''; 
            tbody.innerHTML = ''; 

            const columnsForCurrentTableDisplayView = tableColumnDefinitions.filter(colDef => 
                !colDef.isExpandedOnly || (colDef.isExpandedOnly && currentTableDisplayView === 'expanded')
            );

            const headerRow = document.createElement('tr');
            columnsForCurrentTableDisplayView.forEach(colDef => {
                const th = document.createElement('th');
                th.textContent = colDef.header;
                if (colDef.centerAlign) {
                    th.classList.add('text-center-col');
                }
                th.classList.add(`col-${colDef.key}`);
                if (colDef.isExpandedOnly) {
                    th.classList.add('expanded-only-col');
                }
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            allPlayersData.forEach(player => { 
                const tr = document.createElement('tr');

                if (player.pos === 1) {
                    tr.classList.add('row-first-place');
                } else if (player.pos === 2 || player.pos === 3) {
                    tr.classList.add('row-money-position');
                } else if (player.pos === 15 || player.pos === 16) {
                    tr.classList.add('row-relegation-zone');
                }

                columnsForCurrentTableDisplayView.forEach(colDef => {
                    const td = document.createElement('td');
                    
                    if (colDef.key === 'playerWithMovement') {
                        td.innerHTML = player[colDef.key] !== undefined ? player[colDef.key] : 'N/A';
                    } else {
                        td.textContent = player[colDef.key] !== undefined && player[colDef.key] !== null ? player[colDef.key] : 'N/A';
                    }

                    if (colDef.centerAlign) {
                        td.classList.add('text-center-col');
                    }
                    td.classList.add(`col-${colDef.key}`); 
                    
                    if (colDef.key === 'playerWithMovement') { 
                        const wrapper = td.querySelector('.movement-indicator-wrapper');
                        if(wrapper) { 
                           wrapper.style.marginRight = (currentTableDisplayView === 'expanded') ? '12px' : '8px';
                        }
                    }

                    if (colDef.isExpandedOnly) {
                        td.classList.add('expanded-only-col');
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }
        
        /**
         * Switches the main application view (Table, Stats, or Settings).
         * @param {string} viewId - The ID of the view to show ('tableView', 'statsView', 'settingsView').
         */
        function switchAppView(viewId) {
            currentAppView = viewId; 

            // Hide all views first
            if (tableViewEl) tableViewEl.style.display = 'none';
            if (statsViewEl) statsViewEl.style.display = 'none';
            if (settingsViewEl) settingsViewEl.style.display = 'none';

            // Show the selected view
            const viewToShow = document.getElementById(viewId);
            if (viewToShow) {
                 viewToShow.style.display = 'block';
            }

            // Fetch data only if table or stats view is selected and data isn't loaded
            if ((viewId === 'tableView' || viewId === 'statsView') && allPlayersData.length === 0 && (!messageAreaEl || !messageAreaEl.textContent.includes("Error"))) { 
                fetchDataAndInitialize(); // Use combined fetch function
            }

            // Update active state on nav items
            navItems.forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-view') === viewId);
            });
        }

        /**
         * Applies the selected accent color based on current theme mode.
         * @param {string} colorValue - The base hex value (light mode) of the accent color.
         */
        function applyAccentColor(colorValue) {
             // Safeguard added
             if (!accentColors || accentColors.length === 0) {
                console.error("Accent colors not defined or empty!");
                return; 
            }
            const selectedColorObject = accentColors.find(c => c.value === colorValue) || accentColors[0]; 
            const isDarkMode = bodyElement.classList.contains('theme-dark');

            docElement.style.setProperty('--primary-accent-color', isDarkMode ? selectedColorObject.darkValue : selectedColorObject.value);
            docElement.style.setProperty('--primary-accent-light', isDarkMode ? selectedColorObject.darkLightValue : selectedColorObject.lightValue);
            docElement.style.setProperty('--primary-header-bg', isDarkMode ? selectedColorObject.darkHeaderBg : selectedColorObject.headerBg);
            docElement.style.setProperty('--primary-accent-text-on-light-bg', isDarkMode ? selectedColorObject.darkTextOnLight : selectedColorObject.textOnLight);
            
            if (accentColorSwatchesEl) {
                accentColorSwatchesEl.querySelectorAll('.color-swatch').forEach(swatch => {
                    swatch.classList.toggle('active-swatch', swatch.dataset.colorValue === colorValue);
                });
            }
            localStorage.setItem('accentColor', colorValue); 
        }

        /**
         * Applies the selected theme mode (light, dark, or system).
         * @param {string} mode - 'light', 'dark', or 'system'.
         */
        function applyThemeMode(mode) {
            bodyElement.classList.remove('theme-dark', 'theme-light'); 
            
            if (mode === 'dark') {
                bodyElement.classList.add('theme-dark');
            } else if (mode === 'light') {
                 // No class needed
            } else { // System
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    bodyElement.classList.add('theme-dark');
                }
            }
            localStorage.setItem('themeMode', mode);
            
            // Safeguard before accessing accentColors
            if (!accentColors || accentColors.length === 0) {
                console.error("Cannot apply accent color: Accent colors not defined or empty!");
                 return; // Exit if colors not ready
            }
            const storedAccent = localStorage.getItem('accentColor') || accentColors[0].value;
            applyAccentColor(storedAccent); 
        }

        // --- Populate Settings Controls ---
        function populateAccentSwatches() {
            if (!accentColorSwatchesEl) return; 
            accentColorSwatchesEl.innerHTML = ''; 
            accentColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.classList.add('color-swatch');
                swatch.style.backgroundColor = color.value; 
                swatch.dataset.colorValue = color.value; 
                swatch.setAttribute('title', color.name); 
                swatch.addEventListener('click', () => applyAccentColor(color.value));
                accentColorSwatchesEl.appendChild(swatch);
            });
        }

        /**
         * Populates the player dropdown in the Stats view.
         */
        function populateStatsDropdown() {
            if (!playerStatsSelectEl || allPlayersData.length === 0) return;

            // Clear existing options except the placeholder
            playerStatsSelectEl.length = 1; 

            // Sort players alphabetically for the dropdown
            const sortedPlayers = [...allPlayersData].sort((a, b) => a.player.localeCompare(b.player));

            sortedPlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.player; // Use player name as value 
                option.textContent = player.player;
                playerStatsSelectEl.appendChild(option);
            });
        }

        /**
         * Displays stats (hero panel + chart) for the selected player.
         * @param {string} selectedPlayerName - The name of the player selected in the dropdown.
         */
        function displayPlayerStats(selectedPlayerName) {
             if (!playerStatsDisplayEl) return;

             // Clear previous content and hide chart controls initially
             playerStatsDisplayEl.innerHTML = ''; 
             if (statsChartControlsEl) statsChartControlsEl.style.display = 'none';
             if (statsChartContainerEl) statsChartContainerEl.style.display = 'none';
             if (playerStatsChart) { // Destroy previous chart if it exists
                 playerStatsChart.destroy();
                 playerStatsChart = null;
             }

             if (!selectedPlayerName) {
                 playerStatsDisplayEl.innerHTML = 'Select a player from the dropdown above.';
                 playerStatsDisplayEl.style.textAlign = 'center';
                 return;
             }

             const playerData = allPlayersData.find(p => p.player === selectedPlayerName);

             if (playerData) {
                 // --- Create Hero Panel ---
                 const heroPanel = document.createElement('div');
                 heroPanel.classList.add('stats-hero-panel');
                 heroPanel.innerHTML = `
                     <div class="hero-stat">
                         <span class="hero-stat-label">Position</span>
                         <span class="hero-stat-value">${playerData.pos}</span>
                     </div>
                     <div class="hero-stat">
                         <span class="hero-stat-label">Win %</span>
                         <span class="hero-stat-value">${playerData.winPercentage || 'N/A'}</span>
                     </div>
                     <div class="hero-stat">
                         <span class="hero-stat-label">Points</span>
                         <span class="hero-stat-value">${playerData.pts}</span>
                     </div>
                 `;
                 playerStatsDisplayEl.appendChild(heroPanel);
                 
                 // --- Show Chart Controls and Container ---
                 if (statsChartControlsEl) statsChartControlsEl.style.display = 'flex'; // Show controls
                 if (statsChartContainerEl) statsChartContainerEl.style.display = 'block'; // Show chart container

                 // --- Initial Chart Render (or update based on controls) ---
                 updateStatsChart(); // Call function to draw/update chart

             } else {
                 playerStatsDisplayEl.innerHTML = `Could not find data for ${selectedPlayerName}.`; 
                 playerStatsDisplayEl.style.textAlign = 'center';
             }
        }

        /**
         * Updates the stats chart based on current selections.
         */
        function updateStatsChart() {
            const selectedPlayerName = playerStatsSelectEl.value;
            const selectedStat = statDataSelectEl.value;
            const selectedChartType = chartTypeSelectEl.value;

            if (!selectedPlayerName || !statsChartCanvasEl) {
                // Hide container if no player selected
                if (statsChartContainerEl) statsChartContainerEl.style.display = 'none';
                return;
            }
            
            const playerData = allPlayersData.find(p => p.player === selectedPlayerName);
            if (!playerData) return; // Should not happen if dropdown is populated correctly

            let chartData = {};
            let chartOptions = {
                 responsive: true,
                 maintainAspectRatio: false, // Allow canvas resizing
                 plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: getComputedStyle(docElement).getPropertyValue('--text-color') } // Use CSS var for label color
                    },
                    tooltip: {
                        backgroundColor: getComputedStyle(docElement).getPropertyValue('--chart-tooltip-bg'),
                        titleColor: getComputedStyle(docElement).getPropertyValue('--chart-tooltip-text'),
                        bodyColor: getComputedStyle(docElement).getPropertyValue('--chart-tooltip-text'),
                    }
                 },
                 scales: { // Default scales (relevant for bar/line)
                    y: {
                        beginAtZero: true,
                        ticks: { color: getComputedStyle(docElement).getPropertyValue('--chart-label-color') },
                        grid: { color: getComputedStyle(docElement).getPropertyValue('--chart-grid-color') }
                    },
                    x: {
                         ticks: { color: getComputedStyle(docElement).getPropertyValue('--chart-label-color') },
                         grid: { color: getComputedStyle(docElement).getPropertyValue('--chart-grid-color') }
                    }
                 }
            };

            // Prepare data based on selected stat
            if (selectedStat === 'wl') {
                chartData = {
                    labels: ['Wins', 'Losses'],
                    datasets: [{
                        label: 'Wins vs Losses',
                        data: [playerData.w, playerData.l],
                        backgroundColor: [ // Example colors - could be themed
                            'rgba(75, 192, 192, 0.6)', // Greenish
                            'rgba(255, 99, 132, 0.6)'  // Reddish
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                };
                // Hide axes for pie/doughnut
                 if (selectedChartType === 'pie' || selectedChartType === 'doughnut') {
                     delete chartOptions.scales;
                 }

            } else if (selectedStat === 'gfga') {
                 chartData = {
                    labels: ['Goals For', 'Goals Against'],
                    datasets: [{
                        label: 'Goals For vs Against',
                        data: [playerData.gf, playerData.ga],
                         backgroundColor: [ // Example colors
                            'rgba(54, 162, 235, 0.6)', // Bluish
                            'rgba(255, 159, 64, 0.6)' // Orangish
                        ],
                         borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                };
                 // Hide axes for pie/doughnut
                 if (selectedChartType === 'pie' || selectedChartType === 'doughnut') {
                     delete chartOptions.scales;
                 }
            }
            // --- Add more 'else if' blocks here for other stat options ---


            // Destroy previous chart instance if it exists
            if (playerStatsChart) {
                playerStatsChart.destroy();
            }

            // Create new chart
            if (statsChartCanvasEl.getContext('2d') && Object.keys(chartData).length > 0) {
                 if (statsChartContainerEl) statsChartContainerEl.style.display = 'block'; // Ensure container is visible
                 const ctx = statsChartCanvasEl.getContext('2d');
                 playerStatsChart = new Chart(ctx, {
                     type: selectedChartType, // Use selected type
                     data: chartData,
                     options: chartOptions
                 });
            } else {
                 // Hide container if no data prepared
                 if (statsChartContainerEl) statsChartContainerEl.style.display = 'none';
                 console.warn("Could not get canvas context or no data prepared for chart.");
            }
        }


        // --- Event Listeners ---
        viewToggleSwitchEl.addEventListener('change', () => { 
            if (viewToggleSwitchEl.checked) {
                currentTableDisplayView = 'expanded';
                condensedViewLabelEl.classList.remove('active-label');
                fullTableViewLabelEl.classList.add('active-label');
            } else {
                currentTableDisplayView = 'condensed';
                condensedViewLabelEl.classList.add('active-label');
                fullTableViewLabelEl.classList.remove('active-label');
            }
            renderLeagueTable(); 
         });
        navItems.forEach(item => { 
            item.addEventListener('click', (event) => {
                event.preventDefault(); 
                const viewId = item.getAttribute('data-view');
                switchAppView(viewId);
            });
         });

        if(themeModeOptionsEl) { 
            themeModeOptionsEl.addEventListener('change', (event) => {
                if (event.target.name === 'themeMode') {
                    applyThemeMode(event.target.value);
                    // Redraw chart on theme change as colors might need updating
                     if (currentAppView === 'statsView') {
                         updateStatsChart();
                     }
                }
            });
        }

        const systemThemeMatcher = window.matchMedia('(prefers-color-scheme: dark)');
        systemThemeMatcher.addEventListener('change', () => {
            const currentThemeMode = localStorage.getItem('themeMode') || 'system';
            if (currentThemeMode === 'system') {
                applyThemeMode('system'); 
                 // Redraw chart on theme change
                 if (currentAppView === 'statsView') {
                     updateStatsChart();
                 }
            }
        });

        // Listener for the stats player dropdown
        if(playerStatsSelectEl) {
            playerStatsSelectEl.addEventListener('change', (event) => {
                displayPlayerStats(event.target.value); // This will now call updateStatsChart
            });
        }
        // Listeners for chart configuration dropdowns
        if(statDataSelectEl) {
             statDataSelectEl.addEventListener('change', updateStatsChart);
        }
        if(chartTypeSelectEl) {
             chartTypeSelectEl.addEventListener('change', updateStatsChart);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize table view toggle
            if (viewToggleSwitchEl) viewToggleSwitchEl.checked = false; 
            if (condensedViewLabelEl) condensedViewLabelEl.classList.add('active-label');
            if (fullTableViewLabelEl) fullTableViewLabelEl.classList.remove('active-label');
            
            populateAccentSwatches(); // Create the swatches

            // Load and apply saved theme mode FIRST
            const storedThemeMode = localStorage.getItem('themeMode') || 'system';
            if(themeModeOptionsEl){
                 const radioToCheck = themeModeOptionsEl.querySelector(`input[name="themeMode"][value="${storedThemeMode}"]`);
                 if(radioToCheck) radioToCheck.checked = true;
            }
            
            // Apply theme mode (this will also trigger initial accent color application)
            // Check if accentColors is defined before calling applyThemeMode
            if (typeof accentColors !== 'undefined' && accentColors.length > 0) {
                 applyThemeMode(storedThemeMode); 
                 // Load and apply saved accent color (this might be slightly redundant now, but safe)
                 const storedAccentColor = localStorage.getItem('accentColor') || accentColors[0].value;
                 applyAccentColor(storedAccentColor); 
            } else {
                 console.error("Accent colors not ready during initial load.");
                 // Apply theme mode without accent color initially if accentColors isn't ready
                 bodyElement.classList.remove('theme-dark', 'theme-light'); 
                 if (storedThemeMode === 'dark') bodyElement.classList.add('theme-dark');
                 else if (storedThemeMode === 'system' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) bodyElement.classList.add('theme-dark');
            }


            switchAppView('tableView'); // Start on the table view
        });

    </script>
</body>
</html>
